-- Views
CREATE OR REPLACE VIEW EMP_DEPT AS (
	SELECT
		T02F01,
		T02F02,
		T02F03,
		T01F02
	FROM
		EMPLOYEE.EMPT01
		INNER JOIN EMPLOYEE.EMPT02 ON T01F01 = T02F08
);

SELECT
	*
FROM
	EMP_DEPT;

DELETE FROM EMP_DEPT;

CREATE OR REPLACE VIEW EMP_NAME AS (
	SELECT
		T02F01,
		T02F02,
		T02F03
	FROM
		EMPLOYEE.EMPT02
)
WITH
	CHECK OPTION;

SELECT
	*
FROM
	EMP_NAME;

START TRANSACTION;

DELETE FROM EMP_NAME;

SELECT
	*
FROM
	EMPLOYEE.EMPT02;

ROLLBACK;


-- EXPLAIN
EXPLAIN
SELECT
	T02F01,
	T02F02,
	T02F03,
	T01F02
FROM
	EMPLOYEE.EMPT01
	INNER JOIN EMPLOYEE.EMPT02 ON T01F01 = T02F08
WHERE
	T02F04 = 'PRIYA.PATEL@EXAMPLE.COM';

-- GRUOP_CONCAT
SELECT
	T01F02,
	STRING_AGG (T02F02, ', ')
FROM
	EMPLOYEE.EMPT02
	INNER JOIN EMPLOYEE.EMPT01 ON T01F01 = T02F08
GROUP BY
	T02F08,
	T01F02;

-- CASE
SELECT
	T02F01,
	T02F02,
	T02F03,
	CASE
		WHEN T02F07 > 100000 THEN 'HIGH'
		ELSE 'AVERAGE'
	END
FROM
	EMPLOYEE.EMPT02;

-- if else
SELECT
    T02F01,
    T02F02,
    T02F03,
    CASE
        WHEN T02F07 > 100000 THEN 'HIGH'
        ELSE 'AVERAGE'
    END AS salary_level
FROM employee.empt02;


-- upsert
INSERT INTO
	EMPLOYEE.EMPT01 (T01F01, T01F02, T01F03)
VALUES
	(1, 'IT', 'Delhi') ON CONFLICT(T01F01) DO
UPDATE SET T01F02 =	EXCLUDED.T01F02,
	T01F03 = 'Anand';
SELECT * FROM EMPLOYEE.EMPT01;

-- WINDOW FUNCTION
SELECT
	T02F01,
	T02F02,
	T02F03,
	T02F07,
	T01F02,
	ROW_NUMBER() OVER (
		PARTITION BY
			T02F08
		ORDER BY
			T02F07 DESC
	) AS SALARY_RANK,
	SUM(T02F07) OVER (
		PARTITION BY
			T02F08
		ORDER BY
			T02F07 DESC
	) AS RUNNING_TOTAL,
	LAG(T02F07, 1, 0) OVER (
		PARTITION BY
			T02F08
		ORDER BY
			T02F07 DESC
	) AS PREVIOUS_SCANNED_SALARY
FROM
	EMPLOYEE.EMPT02
	INNER JOIN EMPLOYEE.EMPT01 ON T01F01 = T02F08;

SELECT
	T02F01,
	T02F02,
	T02F03,
	T02F07,
	T01F02,
	ROW_NUMBER() OVER W AS SALARY_RANK,
	SUM(T02F07) OVER W AS RUNNING_TOTAL,
	LAG(T02F07, 1, 0) OVER W AS PREVIOUS_SCANNED_SALARY
FROM
	EMPLOYEE.EMPT02
	INNER JOIN EMPLOYEE.EMPT01 ON T01F01 = T02F08
WINDOW
	W AS (
		PARTITION BY
			T02F08
		ORDER BY
			T02F07 DESC
	);

-- Recursion using CTE
WITH RECURSIVE
	NUMBERS AS (
		SELECT
			1 AS N -- Base case: Start with 1
		UNION ALL
		SELECT
			N + 1 -- Recursive case: Add 1 each time
		FROM
			NUMBERS
		WHERE
			N < 10 -- Stopping condition
	)
SELECT
	*
FROM
	NUMBERS;



-- PREPARE EXECUTE
PREPARE get_employee (numeric) AS
SELECT T02F02, T02F03, T02F07
FROM EMPLOYEE.EMPT02
WHERE T02F07 > $1;

EXECUTE get_employee(100000);

DEALLOCATE get_employee;